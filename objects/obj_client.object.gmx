<!--This Document is generated by GameMaker, if you edit it by hand then you do so at your own risk!-->
<object>
  <spriteName>&lt;undefined&gt;</spriteName>
  <solid>0</solid>
  <visible>-1</visible>
  <depth>0</depth>
  <persistent>0</persistent>
  <parentName>&lt;undefined&gt;</parentName>
  <maskName>&lt;undefined&gt;</maskName>
  <events>
    <event eventtype="0" enumb="0">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>/// Initiate Client

ip = "127.0.0.1";
server_port = 6515;
event_perform(ev_other, ev_user0);

all_sprites = ds_list_create();
sprites = 0;

command_buffer = buffer_create(256, buffer_grow, 1);
cmd_id = 0;

UP = 0;
DOWN = 1;
LEFT = 2;
RIGHT = 3;

command[UP] = false;
command[DOWN] = false;
command[LEFT] = false;
command[RIGHT] = false;

predict_history = ds_queue_create();
player_number = 0;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="3" enumb="0">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>/// Send keyboard commands every step
/// (if anything being pressed)

var number_of_keys = 0;
if (command[UP]) number_of_keys++;
if (command[DOWN]) number_of_keys++;
if (command[LEFT]) number_of_keys++;
if (command[RIGHT]) number_of_keys++;

if (number_of_keys &gt; 0)
{
    var offset = 3 * (player_number) + 1;
    cmd_id++;

    buffer_seek(command_buffer, buffer_seek_start, 0);
    buffer_write(command_buffer, buffer_string, "input");
    buffer_write(command_buffer, buffer_u32, cmd_id);
    buffer_write(command_buffer, buffer_u8, number_of_keys);
    if (command[UP])
    {
        buffer_write(command_buffer, buffer_s16, vk_up);
        var _y = ds_list_find_value(all_sprites, offset + 1) - 3;
        ds_list_replace(all_sprites, offset + 1, _y);
    }
    if (command[DOWN])
    {
        buffer_write(command_buffer, buffer_s16, vk_down);
        var _y = ds_list_find_value(all_sprites, offset + 1) + 3;
        ds_list_replace(all_sprites, offset + 1, _y);
    }
    if (command[LEFT])
    {
        buffer_write(command_buffer, buffer_s16, vk_left);
        var _x = ds_list_find_value(all_sprites, offset + 0) - 3;
        ds_list_replace(all_sprites, offset + 0, _x);
    }
    if (command[RIGHT])
    {
        buffer_write(command_buffer, buffer_s16, vk_right);
        var _x = ds_list_find_value(all_sprites, offset + 0) + 3;
        ds_list_replace(all_sprites, offset + 0, _x);
    }
    
    var buffer_size = buffer_tell(command_buffer)
    network_send_packet(client, command_buffer, buffer_size);
    
    ds_list_replace(all_sprites, 0, cmd_id);
    var new_prediction = ds_list_create();
    ds_list_copy(new_prediction, all_sprites);
    ds_queue_enqueue(predict_history, new_prediction);
}
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="7" enumb="68">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>/// Client Recieve Data
var eventid = ds_map_find_value(async_load, "id");
var buffer = ds_map_find_value(async_load, "buffer");
var command = string(buffer_read(buffer, buffer_string));

if (command == "update")
{
    player_number = buffer_read(buffer, buffer_u8);
    sprites = buffer_read(buffer, buffer_u8);
    
    var last_cmd_id = buffer_read(buffer, buffer_u32);
    
    received_list = ds_list_create();
    ds_list_add(received_list, last_cmd_id);
    
    for (var i = 0; i &lt; sprites; i++)
    {
        ds_list_add(received_list, buffer_read(buffer, buffer_u16)); // x
        ds_list_add(received_list, buffer_read(buffer, buffer_u16)); // y
        ds_list_add(received_list, buffer_read(buffer, buffer_u16)); // image_blend
    }
    
    // Compare recieved with predicted
    if (ds_queue_size(predict_history) &gt; 0 &amp;&amp; last_cmd_id &gt; 0)
    {
        // Clear out queue until reach cmd_id (or completely)
        var list = ds_queue_head(predict_history);
        while(ds_queue_size(predict_history) &gt; 0 &amp;&amp; ds_list_find_value(list, 0) &lt; last_cmd_id)
            list = ds_queue_dequeue(predict_history);
        
        if (ds_list_find_value(list, 0) == last_cmd_id)
        {
            var offset2 = 3 * (player_number) + 1;
            for (var i = 0; i &lt; ds_list_size(received_list); i++)
            {
                received = ds_list_find_value(received_list, i);
                predicted = ds_list_find_value(list, i);
                
               if (received != predicted &amp;&amp; offset2 &lt;= i &amp;&amp; i &lt; offset2 + 3)
               {
                    with (instance_create(100,100,obj_popup_text))
                        text = "Prediction Error";
                    var offset = received - predicted;
                    
                    for (var j = 0; j &lt; ds_queue_size(predict_history); j++)
                    {
                        var new_list = ds_queue_dequeue(predict_history);
                        var new_value = ds_list_find_value(new_list, i) + offset;
                        ds_list_replace(new_list, i, new_value);
                        ds_queue_enqueue(predict_history, new_list);
                    }
                    
                    ds_list_copy(all_sprites, ds_queue_tail(predict_history));
                }
                else
                {
                    ds_list_replace(all_sprites, i, received);
                }
            }
        }
    }
    else if (last_cmd_id &gt;= 0)
    {
        ds_list_copy(all_sprites, received_list);
    }
}
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="7" enumb="10">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>/// Connect Event

client = network_create_socket(network_socket_tcp);
network_connect(client, ip, server_port);
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="8" enumb="0">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>/// Draw all sprites

var index = 1; // offset by 1 because cmd_id is at [0]
for (var i = 0; i &lt; sprites; i++)
{
    var _x, _y, _blend;
    _x = ds_list_find_value(all_sprites, index++);
    _y = ds_list_find_value(all_sprites, index++);
    _blend = ds_list_find_value(all_sprites, index++);
    
    draw_sprite_ext(spr_player, 0, _x, _y, 1, 1, 0, _blend, 1.0);
    
    draw_set_color(c_white);
    draw_set_halign(fa_center);
    draw_set_valign(fa_top);
    draw_text(_x + 16, _y - 20, "Player " + string(i));
    
    draw_text(_x + 16, _y + 32, string(_x) + ", " + string(_y));
}
draw_set_color(c_white);
draw_set_halign(fa_left);
draw_set_valign(fa_top);
draw_text(0, 0, "Player Num: " + string(player_number)
 + "#Players: " + string(sprites)
 + "#allsprite[0]: " + string(ds_list_find_value(all_sprites, 0))
 + "#allsprite[1]: " + string(ds_list_find_value(all_sprites, 1))
 + "#allsprite[2]: " + string(ds_list_find_value(all_sprites, 2))
 + "#allsprite[3]: " + string(ds_list_find_value(all_sprites, 3))
 + "#CMD_ID: " + string(cmd_id));
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="9" enumb="40">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[DOWN] = true;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="9" enumb="39">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[RIGHT] = true;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="9" enumb="38">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[UP] = true;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="9" enumb="37">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[LEFT] = true;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="10" enumb="40">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[DOWN] = false;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="10" enumb="39">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[RIGHT] = false;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="10" enumb="38">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[UP] = false;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="10" enumb="37">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>command[LEFT] = false;
</string>
          </argument>
        </arguments>
      </action>
    </event>
  </events>
  <PhysicsObject>0</PhysicsObject>
  <PhysicsObjectSensor>0</PhysicsObjectSensor>
  <PhysicsObjectShape>0</PhysicsObjectShape>
  <PhysicsObjectDensity>0.5</PhysicsObjectDensity>
  <PhysicsObjectRestitution>0.100000001490116</PhysicsObjectRestitution>
  <PhysicsObjectGroup>0</PhysicsObjectGroup>
  <PhysicsObjectLinearDamping>0.100000001490116</PhysicsObjectLinearDamping>
  <PhysicsObjectAngularDamping>0.100000001490116</PhysicsObjectAngularDamping>
  <PhysicsObjectFriction>0.200000002980232</PhysicsObjectFriction>
  <PhysicsObjectAwake>-1</PhysicsObjectAwake>
  <PhysicsObjectKinematic>0</PhysicsObjectKinematic>
  <PhysicsShapePoints/>
</object>
